Торговая вселенная - Акции МосБиржи, которые:
1) торгуются в Т-Инвестициях
2) доступны неквалам, **for_qual_investor_flag = 0**
3) доступны для торговли через API, **api_trade_available_flag=1**
4) реальная площадка исполнения расчётов, **real_exchange=1**

Торговая идея - Брать акции из индекса МосБиржи с наибольшой годовой дивидендной доходностью (по аналогии с S&P500 dividend yield), и оптимизировать веса портфеля на основе отношения ожидаемой доходности к CDaR. На данный момент, только лонг-онли.

Типовой пайплайн: 
1) скачать торговые данные в базу - fetch_data.py
2) Провести ресерч стратегии (бэктест и кросс-валидация) в portfolio.ipynb (папка notebooks).
3) Успешные кандидаты попадают в src/skfolio_models.
4) Обертка для исполнения модели и создания ордеров лежит в robot.py PortfolioManager (При необходимости доработать, если появилась новая модель).
5) Работа с ордерами происходит в main.py.
6) Если стратегия в проде устраивает, пункты 2-4 пропускаются.

Для безопасности токен хранится в переменной окружения TINVEST_READ.

Торговые данные лежат в data/main.duckdb, информация по ордерам и операциям находится data/operations.duckdb. А так же вывод ордеров в консоль. В текующем виде, предполагается ребалансировка модели раз в 3 месяца.

В execution.py лежат интерфейсы для работы с ордерами. Работа с ценами в ордер-менеджере пока не идеальна из-за неактуальных цен.

Критерии приемки следующие:
1) Стратегия лучше бенчмарк-а (равновзвес акций из Индекса Мосбиржи) по большинству метрик (ANNUALIZED_SHARPE_RATIO, CDAR_RATIO, ANNUALIZED_SORTINO_RATIO, CDAR, SKEW).
2) Для проверки 1-ого пункта проводился множественной WalkForward и оценивалось распределение метрик (пока что только визуально, без статтестов).
3) Учитывались транзакции и прочие косты в размере 1% (в skfolio это происходит неочевидным образом).

Особенности модели:
1) модель в целом склонна брать больше tail-риска (судя по CVaR). Без регуляризации и max_weight-а происходил черрипик $TRMK, что давало большой PnL. 
2) Есть риск того, что модель может упасть из того, что оптимизация не сойдется. Пока что решается множественной кросс-валидацией.
3) Число я к сожалению не приведу, но уверен, что у модели сильный exposure к рынку (мы лонг-онли + преселекшн на основе юниверса индекса). И этот риск стоит учитывать.

Архитектура:

core-компоненты лежат в src:
 1) data_preprocess.py - утилиты по преобразованию данных (аджаст цены, расчёт див.доходностей итд).
 2) db_load.py - выкачивание торговых данных через API интерфейсы и сохранение в базу данных.
 3) logging.py - логирование вызова функции.
 4) moex_api.py - интерфейсы по работе с MOEX ISS API, либо просто сайтом МосБиржи.
 5) tinkoff_api.py - интерфейсы по работе c T-INVEST API.
 6) tinkoff_convert.py - интерфейсы по преобазованию типов библиотеки invest-python в стандартные типы.
 7) preselection.py - Преселекшн skfolio модели.
 8) skfolio_models.py - skfolio стратегии.

 TODO:
 1) Доработать execution, учет актуальных цен.
 2) Написать бэктест с симуляцией отправки ордеров.
 3) Заинжектить зависимость API интефейсов от клиента, чтобы исключить риск раскрытия ТОКЕН-а.
 4) Избавиться от Pipeline-а в прод версии стратегии, выглядит, как антипаттерн, который сложно тестить.
 5) Сделать динамическую ребалансировку по MAPE.